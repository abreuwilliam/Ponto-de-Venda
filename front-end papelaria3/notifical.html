<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Teste de Notifica√ß√µes Push</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
        #logs { white-space: pre-line; background: #eee; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        button { margin-top: 10px; padding: 10px; }
    </style>
</head>
<body>
<h2>Notifica√ß√µes Push - Teste</h2>
<p>Logs:</p>
<div id="logs">Iniciando...\n</div>
<button onclick="solicitarPermissao()">Solicitar Permiss√£o e Inscrever</button>

<script>
    const log = (msg) => {
        const logs = document.getElementById('logs');
        logs.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    };

    const PUBLIC_KEY = 'BH7tqCBB2tRm_uOalhTTnj-uV2hHxQtOvXpfhIiW0VZdWOzuRGoUZUo1eRN-8M_wee5_6ViUYRb9MubSFOIuMAY'; // Substitua pela sua

    const token = 'SEU_TOKEN_JWT_AQUI'; // Adicione seu token se necess√°rio

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = atob(base64);
        return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));
    }

    async function solicitarPermissao() {
        if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
            log("‚ùå Navegador n√£o suporta Push API ou Service Workers.");
            return;
        }

        const permission = await Notification.requestPermission();
        log("üîê Permiss√£o: " + permission);

        if (permission !== 'granted') {
            log("üö´ Permiss√£o negada.");
            return;
        }

        const registration = await navigator.serviceWorker.register('sw.js');
        log("‚úÖ Service Worker registrado.");

        const subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(PUBLIC_KEY)
        });

        log("üì¨ Inscri√ß√£o realizada com sucesso:");
        log(JSON.stringify(subscription, null, 2));

        try {
            const response = await fetch('https://ponto-de-venda-1.onrender.com/api/subscriptions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(subscription)
            });

            if (response.ok) {
                log("üü¢ Inscri√ß√£o enviada ao servidor com sucesso.");
            } else {
                log("‚ö†Ô∏è Falha ao enviar inscri√ß√£o. Status: " + response.status);
            }
        } catch (error) {
            log("üî¥ Erro ao enviar inscri√ß√£o: " + error.message);
        }
    }
</script>
</body>
</html>
